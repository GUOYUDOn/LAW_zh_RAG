from langchain.prompts import PromptTemplate 


# 检测用户提出的问题是否与法律问题有关
check_law_prompt_template = """
你是一名专业律师，请判断以下问题是否涉及法律问题。  
**要求** ：
1. 如果问题明确与法律无关（如纯技术、数学、科学、日常生活常识等），请回答 "no"。  
2. 如果问题涉及法律、法规、司法解释、合同、诉讼、仲裁、法律责任、权利义务等法律概念，或者可能涉及法律问题，即使不完全确定，请保守回答 "yes"。  
3. 如问题表述模糊、潜在涉及法律，或存在法律适用空间，也应倾向回答 "yes"，避免误判。  
回答须客观严谨，不允许添加任何解释或编造内容。你只能回答 "yes" 或 "no"，不得生成其他回答。
问题: {question}
"""
CHECK_LAW_PROMPT = PromptTemplate(template=check_law_prompt_template, input_variables=["question"])


# 检测用户当前提出的问题是否与前一个问题有关
check_relevance_prompt_template = """
前一个问题是：" {prev_question} "  
当前问题是：" {question} "  
请你判断当前问题是否与前一个问题相关，并考虑以下情况：  
1. 当前问题是否是对前一个问题的补充、追问、澄清或延续？  
2. 当前问题是否包含指代词（如“这个行为”“这种情况”等），并且这些指代词所指代的内容可以从前一个问题中推断出来？  
3. 当前问题是否涉及与前一个问题相同的法律概念、事实背景或核心论点，即使措辞有所不同？  
如果满足上述任意一项，请回答yes。  
如果当前问题的主题、讨论方向完全不同，或者无法从前一个问题推断出其相关性，请回答no。注意只能回答yes或no，不允许其它回答。不允许编造信息，不允许添加额外解释或推测。
"""  

CHECK_RELEVANCE_PROMPT = PromptTemplate(template=check_relevance_prompt_template, input_variables=["question", "prev_question"])


# 对当前用户的问题进行指代补全与增强
enhance_question_prompt_template = """
你是一位专业的法律智能助手，任务是优化用户输入的问题，使其更加清晰、完整，并结合上一轮问题补全可能缺失的上下文。
先前的问题："{prev_query_text}"
当前的问题："{query_text}"
请基于上述两个问题：
1. 合并两个问题，避免重复表达。
2. 去重，删除冗余内容。
3. 补全语义，使问题更加完整，确保 AI 更容易理解。
你的输出：仅输出优化后的问题，不要包含解释或其他内容。
"""
ENHANCE_QUESTION_PROMPT = PromptTemplate(template=enhance_question_prompt_template, input_variables=["query_text", "prev_query_text"])


# 将提问变为正式化表达并提取关键词
formalize_question_prompt_template = """
你是一位专业的法律智能助手，任务是优化用户输入的问题，使其更加正式、精准，并提取核心关键词，以便后续检索。
用户原始问题：" {query_text} "
你的任务：
1. 转换为正式书面表达：去除口语化词汇（如 “啊”、“呢”、“吧”），调整语法，使问题更加专业、正式。
2. 提取关键词：找出该问题最核心的法律概念，确保可用于数据库检索。
3. 优化检索问题：基于正式化的问题，将关键词附加在末尾，形成适合检索的 Query。
请直接输出优化后的问题 + 问号 + 关键词，不要换行，关键词之间用逗号连接，不要添加额外解释或说明。
"""
FORMALIZE_QUESTION_PROMPT = PromptTemplate(template=formalize_question_prompt_template, input_variables=["query_text"])


#(RAG)生成最终问题
generation_prompt_template = """
你是一位经验丰富的专业律师。请基于以下参考信息 `{refer_text}`，并结合你的专业知识，按照以下要求，严谨、清晰地回答用户的问题 `{query_text}`。  
## **要求**：
1. **法律依据**：
   - 仅引用与 `{query_text}` 直接相关的法律条款或案例，并明确其来源，确保引用具有高度适用性。  
   - 对于法律条款，需加上 **“法律依据”** 标注，并严格按照原文引用，不得修改或自行补充。  
   - 对于网页信息，请列出网页标题和网址，确保可追溯性。  
   - 若 `{refer_text}` 中未提供直接相关的法律条款，可结合自身知识进行法律分析，但不得编造法律条文。  

2. **逻辑分析**：
   - 结合实际情况，对适用法律依据进行严谨分析，确保论证清晰、结构严密。  
   - 重点说明法律条款如何适用于 `{query_text}`，避免无关或冗长的引用。  
   - 若适用法律有限，可结合类似案例或通行法律原则进行解释，但需明确其来源或背景。

3. **结论与建议**：
   - 在分析基础上，提供明确、可执行的法律建议。  
   - 针对不同可能情形，提出合理的应对方案，以确保法律适用的全面性。  
   - 如当前法律依据存在争议，需列举可能的不同观点，并分析其法律可行性。

请确保你的回答符合专业律师的表达方式，内容严谨、合规，并严格按照以上结构进行回答。
"""
GENERATION_PROMPT = PromptTemplate(template=generation_prompt_template, input_variables=["query_text", "refer_text"])


# 单轮对话检索结果的测评
eval_single_prompt_template = """
你是一位经验丰富的律师，精通法律文本分析和法律检索，擅长判断检索结果是否与用户提出的法律问题相关。  
## **要求**：
1. **相关性判断标准**：请基于法律条款、司法解释、判例、法律原则等因素，综合判断检索结果是否能够解答用户的问题或提供有价值的法律依据。  
2. **输出格式**：请返回一个整数（0-4），表示检索结果列表中与用户问题直接相关的条目数量。  
3. **相关性定义**：  
   - 高度相关（计入相关结果）：检索结果能够直接解答用户问题，提供适用的法律规定或案例。  
   - 部分相关（计入相关结果）：检索结果包含间接支持的信息，如相近法条、相关判例或类似法律概念。  
   - 不相关（不计入相关结果）：检索结果与用户问题无关，或仅涉及泛泛法律知识，无法直接帮助解答。  

请基于上述标准，判断检索结果 `{refer_text}` 中有多少条与 `{query_text}` 相关，并仅返回该整数（0-4）。  
"""
EVAL_SINGLE_PROMPT = PromptTemplate(template=eval_single_prompt_template, input_variables=["query_text", "refer_text"])


# 端到端回答打分
eval_end2end_prompt_template = eval_end2end_prompt_template = eval_end2end_prompt_template = """
你是一名资深法律分析师，负责根据用户的原始问题对比两个法律回答的质量，并给出客观的评分。你的任务是基于以下标准，严格评估两个回答的优劣，并返回**仅包含评分结果的 JSON 格式**，不得添加额外文本。

### **评分标准（0-100分整数制）**
你需要从以下四个维度评估每个回答，每个维度有明确的评分标准：

1. **法律证据完整性（30分）**
   - 30-26分：引用了所有相关法律条文，并且准确无误，未遗漏任何关键条款。
   - 25-20分：引用了主要法律条文，但可能遗漏了部分相关法条。
   - 19-10分：引用了一些法律条文，但有明显缺失或错误。
   - 9-0分：几乎没有引用法律条文，或引用了完全错误的条文。

2. **法律依据相关性（25分）**
   - 25-21分：所引用的法律条文与问题高度相关，无冗余引用。
   - 20-15分：主要相关，但有部分不必要或次要的法条。
   - 14-5分：大部分引用的法律条文与问题关系不大。
   - 4-0分：基本无关，甚至误导性较强。

3. **充分引用法律依据进行分析（25分）**
   - 25-21分：详细结合法律条款进行分析，论证清晰，案例适用精准。
   - 20-15分：有一定程度的法律分析，但缺乏细节或不够深入。
   - 14-5分：只是罗列法条，没有深入分析，仅是法条堆砌。
   - 4-0分：没有进行有效分析，仅复制法律条款，或分析完全错误。

4. **逻辑清晰度与准确性（20分）**
   - 20-17分：论证严密，语言精准，推理无误，无明显漏洞。
   - 16-12分：逻辑较清晰，但部分论证不够严密或存在模糊之处。
   - 11-5分：逻辑较为混乱，结论含糊不清，论述有缺陷。
   - 4-0分：逻辑混乱，表达不清，甚至前后矛盾。

---

## **输入**
你将收到一个法律问题以及两个法律回答（response1 和 response2）。请严格按照评分标准评估它们，并**仅返回 JSON 评分结果，不要添加任何额外文本、解释或格式**。

**法律问题**：
{query_text}

**Response 1**：
{response1}

**Response 2**：
{response2}

---

## **输出要求**
**请严格按照以下 JSON 格式返回评分结果，不得添加任何解释或 Markdown 代码块：**
```json
{{
  "score1": 评分1,
  "score2": 评分2
}}
"""
EVAL_END2END_PROMPT = PromptTemplate(template=eval_end2end_prompt_template, input_variables=["query_text", "response1", "response2"])


# baseline生成
baseline_generation_prompt_template = """
你是一位经验丰富的法律专家，擅长解读法律条文并提供专业法律建议。请基于 {query_text}，按照以下结构作答：
**法律依据**：引用相关法律法规、司法解释或判例，并提供准确的法律来源。
**逻辑分析**：结合实际情况，对上述法律依据进行严谨分析，确保论证清晰、结构严密。避免模糊表述或主观推测，重点说明法律条款如何适用于当前问题。
**结论与建议**：在分析基础上，提供明确、可执行的法律建议。针对不同可能情形，提出合理的应对方案，以确保法律适用的全面性。
请确保你的回答符合专业律师的表达方式，内容严谨、合规，并严格按照以上结构进行回答。
"""
BASELINE_GENERATION_PROMPT = PromptTemplate(template=baseline_generation_prompt_template, input_variables=["query_text"])


# 端到端正确率评估
eval_accuracy_end2end_prompt_template = """
你是一位资深的律师，精通法律条文、司法解释及实际案例分析。你的任务是基于用户问题、参考回复（如有）以及模型回复，严格按照法律专业知识进行判断，并避免误判。

### **评判标准**
1. **正确（yes）**：
   - 模型的回复内容符合法律规定，且与参考回复在核心法律观点、逻辑推理和结论上等效，即使表述不同亦可接受。
   - 回复涵盖了用户问题所需的关键信息，且未造成法律误导。
2. **错误（no）**：
   - 模型的回复存在法律适用错误、事实错误、逻辑错误，或者可能误导用户，使其做出错误的法律决策。
   - 回复偏离了法律核心原则，或提供的信息与参考回复明显不一致，导致法律结论不同。

**特别注意**：
- **不因措辞不同而误判**：如果模型的回答表达方式不同，但核心法律观点一致，仍应判定为“yes”。
- **不因部分缺失而误判**：如果模型的回答略有缺失但不影响核心法律结论，仍可接受。
- **仅判断正确性，不考虑风格**：如回复内容正确，但用词风格不同，不应影响判断。

请仅回答 **"yes"** 或 **"no"**，不得附加任何解释或补充说明。
---
**用户问题：**
{query_text}
**参考回复（如有）：**
{answer_text}
**模型回复：**
{response}
"""

EVAL_ACCURACY_END2END_PROMPT = PromptTemplate(template=eval_accuracy_end2end_prompt_template, input_variables=["query_text", "answer_text", "response"])